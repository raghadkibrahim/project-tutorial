{
  "hash": "ff2f8d7aac093be7d3df441780a09dd7",
  "result": {
    "engine": "jupyter",
    "markdown": "# Data Preprocessing {.unnumbered}\n\n## Import Libraries\n\n::: {#9c14cc88 .cell execution_count=1}\n``` {.python .cell-code}\nimport pandas as pd\nfrom pathlib import Path\nfrom datasets import load_dataset\nimport numpy as np\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n/opt/anaconda3/envs/openai_env/lib/python3.11/site-packages/tqdm/auto.py:21: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html\n  from .autonotebook import tqdm as notebook_tqdm\n```\n:::\n:::\n\n\n## Load Dataset\n\n::: {#562d0d57 .cell execution_count=2}\n``` {.python .cell-code}\nverdicts = load_dataset(\n    \"csv\",\n    data_files=\"hf://datasets/raghadkibrahim/dxb_court_data/Verdicts.csv\",\n    streaming=True,\n    split=\"train\",\n)\n```\n:::\n\n\n## Show a sample\n\n::: {#9de7a01b .cell execution_count=3}\n``` {.python .cell-code}\nimport itertools\n\nsample = list(verdicts.take(5000)) \ndf = pd.DataFrame(sample)\n\ndf.head() \n```\n\n::: {.cell-output .cell-output-display execution_count=3}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>case_subtype_code</th>\n      <th>case_year</th>\n      <th>case_serial_number</th>\n      <th>decision_number</th>\n      <th>judgment_date</th>\n      <th>recitals</th>\n      <th>insertion_date</th>\n      <th>last_update_date</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>1</td>\n      <td>1992</td>\n      <td>1306</td>\n      <td>14</td>\n      <td>01-08-2022</td>\n      <td>بعد الاطلاع على الأوراق و سماع المرافعة؛؛؛    ...</td>\n      <td>01-08-2022</td>\n      <td>None</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>11</td>\n      <td>2016</td>\n      <td>629</td>\n      <td>22</td>\n      <td>19-09-2022</td>\n      <td>بعد سماع المرافعة الشفوية ومطالعة الاوراق:حيث ...</td>\n      <td>19-09-2022</td>\n      <td>None</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>11</td>\n      <td>2016</td>\n      <td>1005</td>\n      <td>18</td>\n      <td>25-04-2024</td>\n      <td>بعد مطالعة الملف الإلكتروني سماع المرافعة حيث ...</td>\n      <td>25-04-2024</td>\n      <td>None</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>11</td>\n      <td>2018</td>\n      <td>634</td>\n      <td>21</td>\n      <td>30-05-2022</td>\n      <td>بعد سماع المرافعة والاطلاع على الأوراق  : حيث ...</td>\n      <td>30-05-2022</td>\n      <td>None</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>11</td>\n      <td>2019</td>\n      <td>1959</td>\n      <td>16</td>\n      <td>28-02-2022</td>\n      <td>بعد سماع المرافعة ومطالعة الاوراق . حيث ان وقا...</td>\n      <td>28-02-2022</td>\n      <td>None</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n## Clean `recitals` Column\n\nWe will start by ceating a function to clean the text in the `recitals` column.\n\n::: {#b98abeba .cell execution_count=4}\n``` {.python .cell-code}\ndef clean_text(text):\n    text = re.sub(r'\\s+', ' ', text)  # remove extra spaces\n    text = re.sub(r'[^\\w\\s]', '', text)  # remove punctuation\n    return text.strip()\n```\n:::\n\n\nApplying the function:\n\n::: {#718567af .cell execution_count=5}\n``` {.python .cell-code}\nimport re\n\ndf['cleaned_recitals'] = df['recitals'].apply(clean_text)\n\ndf.head()\n```\n\n::: {.cell-output .cell-output-display execution_count=5}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>case_subtype_code</th>\n      <th>case_year</th>\n      <th>case_serial_number</th>\n      <th>decision_number</th>\n      <th>judgment_date</th>\n      <th>recitals</th>\n      <th>insertion_date</th>\n      <th>last_update_date</th>\n      <th>cleaned_recitals</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>1</td>\n      <td>1992</td>\n      <td>1306</td>\n      <td>14</td>\n      <td>01-08-2022</td>\n      <td>بعد الاطلاع على الأوراق و سماع المرافعة؛؛؛    ...</td>\n      <td>01-08-2022</td>\n      <td>None</td>\n      <td>بعد الاطلاع على الأوراق و سماع المرافعة وحيث إ...</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>11</td>\n      <td>2016</td>\n      <td>629</td>\n      <td>22</td>\n      <td>19-09-2022</td>\n      <td>بعد سماع المرافعة الشفوية ومطالعة الاوراق:حيث ...</td>\n      <td>19-09-2022</td>\n      <td>None</td>\n      <td>بعد سماع المرافعة الشفوية ومطالعة الاوراقحيث ا...</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>11</td>\n      <td>2016</td>\n      <td>1005</td>\n      <td>18</td>\n      <td>25-04-2024</td>\n      <td>بعد مطالعة الملف الإلكتروني سماع المرافعة حيث ...</td>\n      <td>25-04-2024</td>\n      <td>None</td>\n      <td>بعد مطالعة الملف الإلكتروني سماع المرافعة حيث ...</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>11</td>\n      <td>2018</td>\n      <td>634</td>\n      <td>21</td>\n      <td>30-05-2022</td>\n      <td>بعد سماع المرافعة والاطلاع على الأوراق  : حيث ...</td>\n      <td>30-05-2022</td>\n      <td>None</td>\n      <td>بعد سماع المرافعة والاطلاع على الأوراق  حيث إن...</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>11</td>\n      <td>2019</td>\n      <td>1959</td>\n      <td>16</td>\n      <td>28-02-2022</td>\n      <td>بعد سماع المرافعة ومطالعة الاوراق . حيث ان وقا...</td>\n      <td>28-02-2022</td>\n      <td>None</td>\n      <td>بعد سماع المرافعة ومطالعة الاوراق  حيث ان وقائ...</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n## Create Semantic Embeddings\n\nEmbeddings turn text into numeric vectors that capture meaning. There are a few options we could choose from, but in this case we shall use `sentence_transformer` for its excellent multingual abilities.\n\n::: {#d696540c .cell execution_count=6}\n``` {.python .cell-code}\nimport torch\nfrom sentence_transformers import SentenceTransformer\n\ndevice = \"mps\" if torch.backends.mps.is_available() else \"cpu\"\n\nmodel = SentenceTransformer(\"sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2\")\nmodel = model.to(device)\n```\n:::\n\n\n::: {#d2fd7609 .cell execution_count=7}\n``` {.python .cell-code}\n# Prepare texts \ntexts = df[\"cleaned_recitals\"].astype(str).tolist()\n\n# Encode in chunks to control memory; keep batch_size modest on MPS\nemb_chunks = []\nfor i in range(0, len(texts), 2000):  \n    batch = texts[i:i+2000]\n    embs = model.encode(\n        batch,\n        batch_size=64,                          # 32–128 is usually fine; tweak if you see OOM\n        show_progress_bar=True,\n        convert_to_numpy=True,\n        normalize_embeddings=True         \n    )\n    emb_chunks.append(embs.astype(\"float32\"))   # FAISS prefers float32\nembeddings = np.vstack(emb_chunks)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\rBatches:   0%|          | 0/32 [00:00<?, ?it/s]\rBatches:   3%|▎         | 1/32 [00:00<00:18,  1.71it/s]\rBatches:   6%|▋         | 2/32 [00:00<00:13,  2.28it/s]\rBatches:   9%|▉         | 3/32 [00:01<00:11,  2.43it/s]\rBatches:  12%|█▎        | 4/32 [00:01<00:10,  2.67it/s]\rBatches:  16%|█▌        | 5/32 [00:01<00:10,  2.70it/s]\rBatches:  19%|█▉        | 6/32 [00:02<00:09,  2.81it/s]\rBatches:  22%|██▏       | 7/32 [00:02<00:08,  2.97it/s]\rBatches:  25%|██▌       | 8/32 [00:02<00:07,  3.02it/s]\rBatches:  28%|██▊       | 9/32 [00:03<00:07,  3.19it/s]\rBatches:  31%|███▏      | 10/32 [00:03<00:06,  3.31it/s]\rBatches:  34%|███▍      | 11/32 [00:03<00:06,  3.44it/s]\rBatches:  38%|███▊      | 12/32 [00:04<00:05,  3.47it/s]\rBatches:  41%|████      | 13/32 [00:04<00:05,  3.41it/s]\rBatches:  44%|████▍     | 14/32 [00:04<00:05,  3.46it/s]\rBatches:  47%|████▋     | 15/32 [00:04<00:04,  3.63it/s]\rBatches:  50%|█████     | 16/32 [00:05<00:04,  3.75it/s]\rBatches:  53%|█████▎    | 17/32 [00:05<00:03,  3.79it/s]\rBatches:  56%|█████▋    | 18/32 [00:05<00:03,  3.90it/s]\rBatches:  59%|█████▉    | 19/32 [00:05<00:03,  4.02it/s]\rBatches:  62%|██████▎   | 20/32 [00:06<00:02,  4.14it/s]\rBatches:  66%|██████▌   | 21/32 [00:06<00:02,  4.22it/s]\rBatches:  69%|██████▉   | 22/32 [00:06<00:02,  4.30it/s]\rBatches:  72%|███████▏  | 23/32 [00:06<00:02,  4.38it/s]\rBatches:  75%|███████▌  | 24/32 [00:06<00:01,  4.44it/s]\rBatches:  78%|███████▊  | 25/32 [00:07<00:01,  4.51it/s]\rBatches:  81%|████████▏ | 26/32 [00:07<00:01,  4.58it/s]\rBatches:  84%|████████▍ | 27/32 [00:07<00:01,  4.64it/s]\rBatches:  88%|████████▊ | 28/32 [00:07<00:00,  4.49it/s]\rBatches:  91%|█████████ | 29/32 [00:08<00:00,  4.47it/s]\rBatches:  94%|█████████▍| 30/32 [00:08<00:00,  4.58it/s]\rBatches:  97%|█████████▋| 31/32 [00:08<00:00,  4.68it/s]\rBatches: 100%|██████████| 32/32 [00:08<00:00,  3.75it/s]\n\rBatches:   0%|          | 0/32 [00:00<?, ?it/s]\rBatches:   3%|▎         | 1/32 [00:00<00:11,  2.67it/s]\rBatches:   6%|▋         | 2/32 [00:00<00:10,  2.85it/s]\rBatches:   9%|▉         | 3/32 [00:01<00:09,  3.01it/s]\rBatches:  12%|█▎        | 4/32 [00:01<00:08,  3.16it/s]\rBatches:  16%|█▌        | 5/32 [00:01<00:08,  3.27it/s]\rBatches:  19%|█▉        | 6/32 [00:01<00:07,  3.36it/s]\rBatches:  22%|██▏       | 7/32 [00:02<00:07,  3.46it/s]\rBatches:  25%|██▌       | 8/32 [00:02<00:06,  3.55it/s]\rBatches:  28%|██▊       | 9/32 [00:02<00:06,  3.61it/s]\rBatches:  31%|███▏      | 10/32 [00:02<00:06,  3.59it/s]\rBatches:  34%|███▍      | 11/32 [00:03<00:05,  3.64it/s]\rBatches:  38%|███▊      | 12/32 [00:03<00:05,  3.70it/s]\rBatches:  41%|████      | 13/32 [00:03<00:05,  3.78it/s]\rBatches:  44%|████▍     | 14/32 [00:04<00:04,  3.80it/s]\rBatches:  47%|████▋     | 15/32 [00:04<00:04,  3.79it/s]\rBatches:  50%|█████     | 16/32 [00:04<00:04,  3.78it/s]\rBatches:  53%|█████▎    | 17/32 [00:04<00:03,  3.91it/s]\rBatches:  56%|█████▋    | 18/32 [00:05<00:03,  4.03it/s]\rBatches:  59%|█████▉    | 19/32 [00:05<00:03,  4.12it/s]\rBatches:  62%|██████▎   | 20/32 [00:05<00:02,  4.18it/s]\rBatches:  66%|██████▌   | 21/32 [00:05<00:02,  4.20it/s]\rBatches:  69%|██████▉   | 22/32 [00:05<00:02,  4.15it/s]\rBatches:  72%|███████▏  | 23/32 [00:06<00:02,  4.25it/s]\rBatches:  75%|███████▌  | 24/32 [00:06<00:01,  4.30it/s]\rBatches:  78%|███████▊  | 25/32 [00:06<00:01,  4.36it/s]\rBatches:  81%|████████▏ | 26/32 [00:06<00:01,  4.43it/s]\rBatches:  84%|████████▍ | 27/32 [00:07<00:01,  4.47it/s]\rBatches:  88%|████████▊ | 28/32 [00:07<00:00,  4.53it/s]\rBatches:  91%|█████████ | 29/32 [00:07<00:00,  4.62it/s]\rBatches:  94%|█████████▍| 30/32 [00:07<00:00,  4.68it/s]\rBatches:  97%|█████████▋| 31/32 [00:07<00:00,  4.73it/s]\rBatches: 100%|██████████| 32/32 [00:07<00:00,  4.03it/s]\n\rBatches:   0%|          | 0/16 [00:00<?, ?it/s]\rBatches:   6%|▋         | 1/16 [00:00<00:06,  2.25it/s]\rBatches:  12%|█▎        | 2/16 [00:00<00:05,  2.73it/s]\rBatches:  19%|█▉        | 3/16 [00:01<00:04,  2.84it/s]\rBatches:  25%|██▌       | 4/16 [00:01<00:03,  3.02it/s]\rBatches:  31%|███▏      | 5/16 [00:01<00:03,  3.24it/s]\rBatches:  38%|███▊      | 6/16 [00:01<00:02,  3.47it/s]\rBatches:  44%|████▍     | 7/16 [00:02<00:02,  3.61it/s]\rBatches:  50%|█████     | 8/16 [00:02<00:02,  3.79it/s]\rBatches:  56%|█████▋    | 9/16 [00:02<00:01,  3.92it/s]\rBatches:  62%|██████▎   | 10/16 [00:02<00:01,  4.08it/s]\rBatches:  69%|██████▉   | 11/16 [00:03<00:01,  4.18it/s]\rBatches:  75%|███████▌  | 12/16 [00:03<00:00,  4.26it/s]\rBatches:  81%|████████▏ | 13/16 [00:03<00:00,  4.37it/s]\rBatches:  88%|████████▊ | 14/16 [00:03<00:00,  4.41it/s]\rBatches:  94%|█████████▍| 15/16 [00:03<00:00,  4.52it/s]\rBatches: 100%|██████████| 16/16 [00:04<00:00,  4.73it/s]\rBatches: 100%|██████████| 16/16 [00:04<00:00,  3.86it/s]\n```\n:::\n:::\n\n\n",
    "supporting": [
      "ch1-2_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js\" integrity=\"sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js\" integrity=\"sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}